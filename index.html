<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Postmarks</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: Georgia, 'Times New Roman', serif;
      background: #f5f3ef;
      color: #1a1a1a;
      margin: 0;
      padding: 40px 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      font-size: 28px;
      font-weight: normal;
      letter-spacing: 2px;
      margin-bottom: 40px;
      color: #333;
    }

    .generator {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
    }

    @media (max-width: 700px) {
      body {
        padding: 20px 16px;
      }

      h1 {
        font-size: 20px;
        margin-bottom: 24px;
      }

      .generator {
        grid-template-columns: 1fr;
        gap: 24px;
      }

      .preview-section {
        order: -1;
      }

      .preview-box {
        padding: 20px;
        min-height: auto;
        overflow-x: auto;
      }

      #preview-svg {
        transform: scale(0.85);
        transform-origin: center;
      }

      .symbol-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
      }

      .symbol-option svg {
        width: 24px;
        height: 24px;
      }

      .color-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
      }

      .color-option {
        height: 32px;
      }

      .color-label {
        font-size: 9px;
      }

      .examples {
        gap: 8px;
        margin-bottom: 20px;
      }

      .example-btn {
        padding: 6px 12px;
        font-size: 13px;
      }

      .examples-label {
        width: 100%;
        margin-bottom: 4px;
      }

      .download-btn {
        padding: 14px 24px;
        font-size: 13px;
      }

      .field {
        gap: 6px;
      }

      input[type="text"] {
        font-size: 16px;
        padding: 10px 12px;
      }
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    label {
      font-size: 12px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: #666;
    }

    input[type="text"] {
      font-family: Georgia, serif;
      font-size: 18px;
      padding: 12px 16px;
      border: 1px solid #ddd;
      background: #fff;
      color: #1a1a1a;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #888;
    }

    .symbol-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    .symbol-option {
      aspect-ratio: 1;
      border: 2px solid #ddd;
      background: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: border-color 0.2s;
    }

    .symbol-option:hover {
      border-color: #888;
    }

    .symbol-option.selected {
      border-color: #1a1a1a;
      background: #f9f9f9;
    }

    .symbol-option svg {
      width: 32px;
      height: 32px;
    }

    .color-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    .color-option {
      height: 40px;
      border: 2px solid #ddd;
      cursor: pointer;
      display: flex;
      overflow: hidden;
      transition: border-color 0.2s;
      padding: 0;
      background: none;
      width: 100%;
    }

    .color-option:hover {
      border-color: #888;
    }

    .color-option.selected {
      border-color: #1a1a1a;
    }

    .color-swatch {
      flex: 1;
    }

    .preview-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .preview-box {
      background: #fff;
      border: 1px solid #ddd;
      padding: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 280px;
    }

    #preview-svg {
      filter: drop-shadow(0 2px 8px rgba(0,0,0,0.1));
    }

    .download-btn {
      font-family: Georgia, serif;
      font-size: 14px;
      letter-spacing: 2px;
      text-transform: uppercase;
      padding: 16px 32px;
      background: #1a1a1a;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }

    .download-btn:hover {
      background: #333;
    }

    .download-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .examples {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 32px;
      flex-wrap: wrap;
    }

    .examples-label {
      font-size: 12px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: #666;
    }

    .example-btn {
      font-family: Georgia, serif;
      font-size: 14px;
      padding: 8px 16px;
      background: #fff;
      border: 1px solid #ddd;
      cursor: pointer;
      transition: all 0.2s;
    }

    .example-btn:hover {
      background: #1a1a1a;
      color: #fff;
      border-color: #1a1a1a;
    }

    .color-label {
      font-size: 10px;
      text-align: center;
      margin-top: 4px;
      color: #888;
    }

    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      background: #ddd;
      border-radius: 3px;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: #1a1a1a;
      border-radius: 50%;
      cursor: pointer;
    }

    input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: #1a1a1a;
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }

    #wear-value,
    #rotation-value {
      font-style: italic;
    }

    .wear-field {
      margin-top: 8px;
    }

    .checkbox-field {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-family: Georgia, serif;
      font-size: 14px;
      color: #333;
    }

    .checkbox-field input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #1a1a1a;
    }

    .style-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .style-toggle-btn {
      flex: 1;
      font-family: Georgia, serif;
      font-size: 13px;
      padding: 10px 12px;
      background: #fff;
      border: 1px solid #ddd;
      cursor: pointer;
      transition: all 0.2s;
    }

    .style-toggle-btn:hover {
      border-color: #888;
    }

    .style-toggle-btn.selected {
      background: #1a1a1a;
      color: #fff;
      border-color: #1a1a1a;
    }

    .about-btn {
      font-family: Georgia, serif;
      font-size: 14px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      border: 1px solid #ccc;
      background: #fff;
      color: #888;
      cursor: pointer;
      vertical-align: middle;
      margin-left: 8px;
      transition: all 0.2s;
    }

    .about-btn:hover {
      border-color: #888;
      color: #333;
    }

    .about-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }

    .about-overlay.visible {
      display: flex;
    }

    .about-modal {
      background: #fff;
      padding: 24px 28px;
      max-width: 340px;
      font-size: 14px;
      line-height: 1.7;
      color: #555;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      text-align: center;
    }

    .url-section {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 16px;
      background: #f9f9f9;
      border: 1px solid #ddd;
      margin-bottom: 12px;
    }

    .url-field {
      display: flex;
      gap: 8px;
    }

    .url-input {
      flex: 1;
      font-family: 'Courier New', monospace;
      font-size: 9px;
      padding: 8px 10px;
      border: 1px solid #ddd;
      background: #fff;
      color: #333;
      overflow-x: auto;
      white-space: nowrap;
    }

    .url-input:focus {
      outline: none;
      border-color: #888;
    }

    .copy-btn {
      font-family: Georgia, serif;
      font-size: 11px;
      letter-spacing: 1px;
      text-transform: uppercase;
      padding: 8px 16px;
      background: #fff;
      color: #333;
      border: 1px solid #ddd;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .copy-btn:hover {
      background: #333;
      color: #fff;
      border-color: #333;
    }

    .copy-btn.copied {
      background: #4caf50;
      color: #fff;
      border-color: #4caf50;
    }

    .url-label {
      font-size: 10px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: #888;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>POSTMARKS <button class="about-btn" id="about-btn">?</button></h1>

    <div class="examples">
      <span class="examples-label">Examples:</span>
      <button class="example-btn" data-city="Tokyo" data-country="Japan" data-native="東京" data-symbol="sun" data-palette="0">Tokyo</button>
      <button class="example-btn" data-city="Stockholm" data-country="Sweden" data-native="Sverige" data-symbol="anchor" data-palette="3">Stockholm</button>
      <button class="example-btn" data-city="Marrakech" data-country="Morocco" data-native="مراكش" data-symbol="star" data-palette="16">Marrakech</button>
      <button class="example-btn" data-city="Lisbon" data-country="Portugal" data-native="Lisboa" data-symbol="wave" data-palette="12">Lisbon</button>
      <button class="example-btn" data-city="Santorini" data-country="Greece" data-native="Σαντορίνη" data-symbol="sun" data-palette="8">Santorini</button>
      <button class="example-btn" data-city="Amman" data-country="Jordan" data-native="عمّان" data-symbol="star" data-palette="7">Amman</button>
    </div>

    <div class="generator">
      <div class="controls">
        <div class="field">
          <label>City Name</label>
          <input type="text" id="city-input" placeholder="Tokyo" maxlength="20">
        </div>

        <div class="field">
          <label>Country / Region</label>
          <input type="text" id="country-input" placeholder="Japan" maxlength="30">
        </div>

        <div class="field">
          <label>Native Script (optional)</label>
          <input type="text" id="native-input" placeholder="東京" maxlength="20">
        </div>

        <div class="field">
          <label>Symbol</label>
          <div class="symbol-grid" id="symbol-grid"></div>
        </div>

        <div class="field">
          <label>Color Palette</label>
          <div class="color-grid" id="color-grid"></div>
        </div>
      </div>

      <div class="preview-section">
        <div class="style-toggle">
          <button class="style-toggle-btn selected" data-style="postmark">Postmark</button>
          <button class="style-toggle-btn" data-style="envelope">Envelope</button>
          <button class="style-toggle-btn" data-style="label">Label</button>
        </div>
        <div class="preview-box">
          <div id="preview-svg"></div>
        </div>
        <div class="field wear-field">
          <label>Wear & Tear: <span id="wear-value">Medium</span></label>
          <input type="range" id="wear-slider" min="0" max="100" value="50">
        </div>
        <div class="field wear-field">
          <label>Rotation: <span id="rotation-value">0°</span></label>
          <input type="range" id="rotation-slider" min="-30" max="30" value="0">
        </div>
        <label class="checkbox-field">
          <input type="checkbox" id="sticker-checkbox">
          <span>Show sticker border</span>
        </label>
        <div class="url-section">
          <div class="url-label">SVG URL</div>
          <div class="url-field">
            <input type="text" class="url-input" id="svg-url" readonly>
            <button class="copy-btn" id="copy-url-btn">Copy</button>
          </div>
        </div>
        <button class="download-btn" id="download-btn">Download SVG</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { icons, iconPreviews, colorPalettes, generatePostmark } from './postmark.js';

    // Re-export for use in inline handlers if needed
    window.icons = icons;
    window.iconPreviews = iconPreviews;
    window.colorPalettes = colorPalettes;

    // Worker URL configuration - update this with your deployed worker URL
    const WORKER_URL = 'https://postmarks.nk412.workers.dev';

    // State
    let selectedSymbol = 'compass';
    let selectedPalette = colorPalettes[0];
    let wearLevel = 50;
    let rotationDegrees = 0;
    let showStamp = false;
    let selectedStyle = 'postmark';

    // Initialize symbol grid
    function initSymbolGrid() {
      const grid = document.getElementById('symbol-grid');
      Object.keys(icons).forEach(key => {
        const btn = document.createElement('button');
        btn.className = 'symbol-option' + (key === selectedSymbol ? ' selected' : '');
        btn.innerHTML = iconPreviews[key];
        btn.title = key;
        btn.onclick = () => {
          document.querySelectorAll('.symbol-option').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          selectedSymbol = key;
          updatePreview();
        };
        grid.appendChild(btn);
      });
    }

    // Initialize color grid
    function initColorGrid() {
      const grid = document.getElementById('color-grid');
      colorPalettes.forEach((palette, idx) => {
        const wrapper = document.createElement('div');

        const btn = document.createElement('button');
        btn.className = 'color-option' + (idx === 0 ? ' selected' : '');
        btn.title = palette.name;
        palette.colors.forEach(color => {
          const swatch = document.createElement('div');
          swatch.className = 'color-swatch';
          swatch.style.backgroundColor = color;
          if (color === '#FFFFFF') {
            swatch.style.borderRight = '1px solid #ddd';
          }
          btn.appendChild(swatch);
        });
        btn.onclick = () => {
          document.querySelectorAll('.color-option').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          selectedPalette = palette;
          updatePreview();
        };

        const label = document.createElement('div');
        label.className = 'color-label';
        label.textContent = palette.name;

        wrapper.appendChild(btn);
        wrapper.appendChild(label);
        grid.appendChild(wrapper);
      });
    }

    // Generate postmark SVG using shared module
    function generatePostmarkSvg() {
      const city = document.getElementById('city-input').value || 'London';
      const country = document.getElementById('country-input').value || 'United Kingdom';
      const native = document.getElementById('native-input').value;

      // Find palette index
      const paletteIndex = colorPalettes.findIndex(p => p.name === selectedPalette.name);

      return generatePostmark({
        city,
        country,
        native,
        symbol: selectedSymbol,
        palette: paletteIndex >= 0 ? paletteIndex : 0,
        wear: wearLevel,
        sticker: showStamp,
        style: selectedStyle,
        rotation: rotationDegrees,
        viewBoxPadding: 80  // Smart padding: enough for 30° rotation without excessive whitespace
      });
    }

    // Update preview
    function updatePreview() {
      const svg = generatePostmarkSvg();
      document.getElementById('preview-svg').innerHTML = svg;
      updateWorkerUrl();
    }

    // Generate worker URL with current settings
    function generateWorkerUrl() {
      const city = document.getElementById('city-input').value || 'London';
      const country = document.getElementById('country-input').value || 'United Kingdom';
      const native = document.getElementById('native-input').value;
      const paletteIndex = colorPalettes.findIndex(p => p.name === selectedPalette.name);

      const params = new URLSearchParams();
      params.set('city', city);
      params.set('country', country);
      if (native) params.set('native', native);
      params.set('symbol', selectedSymbol);
      params.set('palette', paletteIndex >= 0 ? paletteIndex : 0);
      params.set('wear', wearLevel);
      if (showStamp && selectedStyle === 'postmark') params.set('sticker', '1');
      if (selectedStyle !== 'postmark') params.set('style', selectedStyle);
      if (rotationDegrees !== 0) params.set('rotation', rotationDegrees);

      return `${WORKER_URL}?${params.toString()}`;
    }

    // Update worker URL display
    function updateWorkerUrl() {
      const workerUrl = generateWorkerUrl();
      document.getElementById('svg-url').value = workerUrl;
    }

    // Copy to clipboard with feedback
    async function copyToClipboard(text, button) {
      try {
        await navigator.clipboard.writeText(text);
        const originalText = button.textContent;
        button.textContent = 'Copied!';
        button.classList.add('copied');
        setTimeout(() => {
          button.textContent = originalText;
          button.classList.remove('copied');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    }

    // Download SVG
    function downloadSvg() {
      const svg = generatePostmarkSvg();
      const city = document.getElementById('city-input').value || 'postmark';
      const filename = city.toLowerCase().replace(/\s+/g, '-') + '.svg';

      const blob = new Blob([svg], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initSymbolGrid();
      initColorGrid();
      updatePreview();

      // Input listeners
      document.getElementById('city-input').addEventListener('input', updatePreview);
      document.getElementById('country-input').addEventListener('input', updatePreview);
      document.getElementById('native-input').addEventListener('input', updatePreview);

      // Download button
      document.getElementById('download-btn').addEventListener('click', downloadSvg);

      // Wear slider
      const wearSlider = document.getElementById('wear-slider');
      const wearValue = document.getElementById('wear-value');
      const wearLabels = ['Pristine', 'Light', 'Medium', 'Heavy', 'Weathered'];

      function updateWearLabel() {
        const idx = Math.min(Math.floor(wearLevel / 25), 4);
        wearValue.textContent = wearLabels[idx];
      }

      wearSlider.addEventListener('input', (e) => {
        wearLevel = parseInt(e.target.value);
        updateWearLabel();
        updatePreview();
      });

      // Rotation slider
      const rotationSlider = document.getElementById('rotation-slider');
      const rotationValue = document.getElementById('rotation-value');

      function updateRotationLabel() {
        rotationValue.textContent = rotationDegrees + '°';
      }

      rotationSlider.addEventListener('input', (e) => {
        rotationDegrees = parseInt(e.target.value);
        updateRotationLabel();
        updatePreview();
      });

      // Sticker checkbox
      const stickerField = document.getElementById('sticker-checkbox').closest('.checkbox-field');
      document.getElementById('sticker-checkbox').addEventListener('change', (e) => {
        showStamp = e.target.checked;
        updatePreview();
      });

      // Style toggle buttons
      const symbolField = document.querySelector('#symbol-grid').closest('.field');
      document.querySelectorAll('.style-toggle-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.style-toggle-btn').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          selectedStyle = btn.dataset.style;
          // Hide sticker option for non-postmark styles
          stickerField.style.display = selectedStyle === 'postmark' ? 'flex' : 'none';
          // Hide symbol option for label style (no icon)
          symbolField.style.display = selectedStyle === 'label' ? 'none' : 'block';
          updatePreview();
        });
      });

      // Copy button
      document.getElementById('copy-url-btn').addEventListener('click', () => {
        const url = document.getElementById('svg-url').value;
        copyToClipboard(url, document.getElementById('copy-url-btn'));
      });

      // About modal
      const aboutOverlay = document.getElementById('about-overlay');
      document.getElementById('about-btn').addEventListener('click', () => {
        aboutOverlay.classList.add('visible');
      });
      aboutOverlay.addEventListener('click', () => {
        aboutOverlay.classList.remove('visible');
      });

      // Example buttons
      document.querySelectorAll('.example-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          // Fill in text fields
          document.getElementById('city-input').value = btn.dataset.city;
          document.getElementById('country-input').value = btn.dataset.country;
          document.getElementById('native-input').value = btn.dataset.native;

          // Select symbol
          const symbolKey = btn.dataset.symbol;
          document.querySelectorAll('.symbol-option').forEach(opt => opt.classList.remove('selected'));
          const symbolBtns = document.querySelectorAll('.symbol-option');
          const symbolKeys = Object.keys(icons);
          const symbolIdx = symbolKeys.indexOf(symbolKey);
          if (symbolIdx >= 0 && symbolBtns[symbolIdx]) {
            symbolBtns[symbolIdx].classList.add('selected');
            selectedSymbol = symbolKey;
          }

          // Select palette
          const paletteIdx = parseInt(btn.dataset.palette);
          document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
          const paletteBtns = document.querySelectorAll('.color-option');
          if (paletteBtns[paletteIdx]) {
            paletteBtns[paletteIdx].classList.add('selected');
            selectedPalette = colorPalettes[paletteIdx];
          }

          updatePreview();
        });
      });
    });
  </script>

  <div class="about-overlay" id="about-overlay">
    <div class="about-modal">
      <img src="postmarks.svg" alt="Postmarks" style="width: 100%; margin-bottom: 16px;">
      Inspired by a time of slower travel, field reports, passport stamps and airmail labels. Create vintage-style dispatch markers for your travel blog.
    </div>
  </div>
</body>
</html>
