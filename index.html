<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Postmark Generator</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: Georgia, 'Times New Roman', serif;
      background: #f5f3ef;
      color: #1a1a1a;
      margin: 0;
      padding: 40px 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
    }

    h1 {
      text-align: center;
      font-size: 28px;
      font-weight: normal;
      letter-spacing: 2px;
      margin-bottom: 40px;
      color: #333;
    }

    .generator {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
    }

    @media (max-width: 700px) {
      body {
        padding: 20px 16px;
      }

      h1 {
        font-size: 20px;
        margin-bottom: 24px;
      }

      .generator {
        grid-template-columns: 1fr;
        gap: 24px;
      }

      .preview-section {
        order: -1;
      }

      .preview-box {
        padding: 20px;
        min-height: auto;
        overflow-x: auto;
      }

      #preview-svg {
        transform: scale(0.85);
        transform-origin: center;
      }

      .symbol-grid {
        grid-template-columns: repeat(4, 1fr);
        gap: 6px;
      }

      .symbol-option svg {
        width: 24px;
        height: 24px;
      }

      .color-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
      }

      .color-option {
        height: 32px;
      }

      .color-label {
        font-size: 9px;
      }

      .examples {
        gap: 8px;
        margin-bottom: 20px;
      }

      .example-btn {
        padding: 6px 12px;
        font-size: 13px;
      }

      .examples-label {
        width: 100%;
        margin-bottom: 4px;
      }

      .download-btn {
        padding: 14px 24px;
        font-size: 13px;
      }

      .field {
        gap: 6px;
      }

      input[type="text"] {
        font-size: 16px;
        padding: 10px 12px;
      }
    }

    .controls {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    label {
      font-size: 12px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: #666;
    }

    input[type="text"] {
      font-family: Georgia, serif;
      font-size: 18px;
      padding: 12px 16px;
      border: 1px solid #ddd;
      background: #fff;
      color: #1a1a1a;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #888;
    }

    .symbol-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    .symbol-option {
      aspect-ratio: 1;
      border: 2px solid #ddd;
      background: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: border-color 0.2s;
    }

    .symbol-option:hover {
      border-color: #888;
    }

    .symbol-option.selected {
      border-color: #1a1a1a;
      background: #f9f9f9;
    }

    .symbol-option svg {
      width: 32px;
      height: 32px;
    }

    .color-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    .color-option {
      height: 40px;
      border: 2px solid #ddd;
      cursor: pointer;
      display: flex;
      overflow: hidden;
      transition: border-color 0.2s;
      padding: 0;
      background: none;
      width: 100%;
    }

    .color-option:hover {
      border-color: #888;
    }

    .color-option.selected {
      border-color: #1a1a1a;
    }

    .color-swatch {
      flex: 1;
    }

    .preview-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .preview-box {
      background: #fff;
      border: 1px solid #ddd;
      padding: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 280px;
    }

    #preview-svg {
      filter: drop-shadow(0 2px 8px rgba(0,0,0,0.1));
    }

    .download-btn {
      font-family: Georgia, serif;
      font-size: 14px;
      letter-spacing: 2px;
      text-transform: uppercase;
      padding: 16px 32px;
      background: #1a1a1a;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
    }

    .download-btn:hover {
      background: #333;
    }

    .download-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .examples {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 32px;
      flex-wrap: wrap;
    }

    .examples-label {
      font-size: 12px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: #666;
    }

    .example-btn {
      font-family: Georgia, serif;
      font-size: 14px;
      padding: 8px 16px;
      background: #fff;
      border: 1px solid #ddd;
      cursor: pointer;
      transition: all 0.2s;
    }

    .example-btn:hover {
      background: #1a1a1a;
      color: #fff;
      border-color: #1a1a1a;
    }

    .color-label {
      font-size: 10px;
      text-align: center;
      margin-top: 4px;
      color: #888;
    }

    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      background: #ddd;
      border-radius: 3px;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: #1a1a1a;
      border-radius: 50%;
      cursor: pointer;
    }

    input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: #1a1a1a;
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }

    #wear-value {
      font-style: italic;
    }

    .wear-field {
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>POSTMARK GENERATOR</h1>

    <div class="examples">
      <span class="examples-label">Examples:</span>
      <button class="example-btn" data-city="Tokyo" data-country="Japan" data-native="東京" data-symbol="sun" data-palette="0">Tokyo</button>
      <button class="example-btn" data-city="Stockholm" data-country="Sweden" data-native="Sverige" data-symbol="anchor" data-palette="3">Stockholm</button>
      <button class="example-btn" data-city="Reykjavik" data-country="Iceland" data-native="Ísland" data-symbol="moon" data-palette="6">Reykjavik</button>
      <button class="example-btn" data-city="Marrakech" data-country="Morocco" data-native="مراكش" data-symbol="star" data-palette="7">Marrakech</button>
      <button class="example-btn" data-city="Ushuaia" data-country="Argentina" data-native="Fin del Mundo" data-symbol="compass" data-palette="8">Ushuaia</button>
      <button class="example-btn" data-city="Kathmandu" data-country="Nepal" data-native="काठमाडौं" data-symbol="mountain" data-palette="2">Kathmandu</button>
    </div>

    <div class="generator">
      <div class="controls">
        <div class="field">
          <label>City Name</label>
          <input type="text" id="city-input" placeholder="Tokyo" maxlength="20">
        </div>

        <div class="field">
          <label>Country / Region</label>
          <input type="text" id="country-input" placeholder="Japan" maxlength="30">
        </div>

        <div class="field">
          <label>Native Script (optional)</label>
          <input type="text" id="native-input" placeholder="東京" maxlength="20">
        </div>

        <div class="field">
          <label>Symbol</label>
          <div class="symbol-grid" id="symbol-grid"></div>
        </div>

        <div class="field">
          <label>Color Palette</label>
          <div class="color-grid" id="color-grid"></div>
        </div>
      </div>

      <div class="preview-section">
        <div class="preview-box">
          <div id="preview-svg"></div>
        </div>
        <div class="field wear-field">
          <label>Wear & Tear: <span id="wear-value">Medium</span></label>
          <input type="range" id="wear-slider" min="0" max="100" value="50">
        </div>
        <button class="download-btn" id="download-btn">Download SVG</button>
      </div>
    </div>
  </div>

  <script>
    // Icon generators - generic travel/postal symbols
    const icons = {
      compass: (color) => `
        <circle cx="218" cy="52" r="11" fill="none" stroke="${color}" stroke-width="1.5"/>
        <polygon points="218,42 220,52 218,56 216,52" fill="${color}"/>
        <polygon points="218,62 216,52 218,48 220,52" fill="none" stroke="${color}" stroke-width="0.75"/>`,

      plane: (color) => `
        <path d="M208 56 L218 46 L228 56 M218 46 L218 62 M212 58 L218 54 L224 58" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>`,

      anchor: (color) => `
        <circle cx="218" cy="42" r="3" fill="none" stroke="${color}" stroke-width="1.5"/>
        <path d="M218 45 L218 62 M210 58 Q210 62 218 62 Q226 62 226 58 M214 52 L222 52" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round"/>`,

      mountain: (color) => `
        <path d="M205 62 L215 44 L220 52 L225 44 L235 62 Z" fill="none" stroke="${color}" stroke-width="1.5" stroke-linejoin="round"/>`,

      wave: (color) => `
        <path d="M205 48 Q210 42 215 48 Q220 54 225 48 Q230 42 235 48" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round"/>
        <path d="M205 58 Q210 52 215 58 Q220 64 225 58 Q230 52 235 58" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round"/>`,

      leaf: (color) => `
        <path d="M218 62 Q208 52 218 38 Q228 52 218 62" fill="none" stroke="${color}" stroke-width="1.5"/>
        <path d="M218 62 L218 48" fill="none" stroke="${color}" stroke-width="1"/>`,

      sun: (color) => `
        <circle cx="218" cy="52" r="8" fill="none" stroke="${color}" stroke-width="1.5"/>
        <g stroke="${color}" stroke-width="1.5" stroke-linecap="round">
          <line x1="218" y1="38" x2="218" y2="42"/><line x1="218" y1="62" x2="218" y2="66"/>
          <line x1="204" y1="52" x2="208" y2="52"/><line x1="228" y1="52" x2="232" y2="52"/>
        </g>`,

      star: (color) => `
        <polygon points="218,40 220,48 228,48 222,54 224,62 218,57 212,62 214,54 208,48 216,48"
                 fill="none" stroke="${color}" stroke-width="1.5"/>`,

      globe: (color) => `
        <circle cx="218" cy="52" r="11" fill="none" stroke="${color}" stroke-width="1.5"/>
        <ellipse cx="218" cy="52" rx="5" ry="11" fill="none" stroke="${color}" stroke-width="1"/>
        <path d="M207 52 L229 52 M209 45 L227 45 M209 59 L227 59" fill="none" stroke="${color}" stroke-width="0.75"/>`,

      envelope: (color) => `
        <rect x="206" y="44" width="24" height="16" fill="none" stroke="${color}" stroke-width="1.5" rx="1"/>
        <path d="M206 44 L218 54 L230 44" fill="none" stroke="${color}" stroke-width="1.5"/>`,

      bird: (color) => `
        <path d="M205 55 Q215 45 218 52 Q221 45 231 55" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round"/>
        <path d="M212 58 Q218 52 224 58" fill="none" stroke="${color}" stroke-width="1.5" stroke-linecap="round"/>`,

      heart: (color) => `
        <path d="M218 60 Q205 50 210 44 Q215 38 218 44 Q221 38 226 44 Q231 50 218 60" fill="none" stroke="${color}" stroke-width="1.5"/>`,

      moon: (color) => `
        <path d="M225 42 A12 12 0 1 0 225 62 A8 8 0 1 1 225 42" fill="none" stroke="${color}" stroke-width="1.5"/>`,

      camera: (color) => `
        <rect x="206" y="46" width="24" height="16" fill="none" stroke="${color}" stroke-width="1.5" rx="2"/>
        <circle cx="218" cy="54" r="5" fill="none" stroke="${color}" stroke-width="1.5"/>
        <rect x="212" y="43" width="6" height="3" fill="none" stroke="${color}" stroke-width="1"/>`,

      coffee: (color) => `
        <path d="M208 44 L210 62 L226 62 L228 44 Z" fill="none" stroke="${color}" stroke-width="1.5"/>
        <path d="M228 48 Q234 48 234 53 Q234 58 228 58" fill="none" stroke="${color}" stroke-width="1.5"/>
        <path d="M214 40 Q214 44 216 44 Q218 44 218 40" fill="none" stroke="${color}" stroke-width="1" stroke-linecap="round"/>`,

      none: () => ''
    };

    // Icon preview SVGs (for selection grid)
    const iconPreviews = {
      compass: `<svg viewBox="0 0 32 32"><circle cx="16" cy="16" r="11" fill="none" stroke="#1a1a1a" stroke-width="1.5"/><polygon points="16,5 18,16 16,20 14,16" fill="#1a1a1a"/></svg>`,
      plane: `<svg viewBox="0 0 32 32"><path d="M6 22 L16 10 L26 22 M16 10 L16 28 M10 24 L16 20 L22 24" fill="none" stroke="#1a1a1a" stroke-width="1.5" stroke-linecap="round"/></svg>`,
      anchor: `<svg viewBox="0 0 32 32"><circle cx="16" cy="6" r="3" fill="none" stroke="#1a1a1a" stroke-width="1.5"/><path d="M16 9 L16 28 M6 24 Q6 28 16 28 Q26 28 26 24 M12 16 L20 16" fill="none" stroke="#1a1a1a" stroke-width="1.5" stroke-linecap="round"/></svg>`,
      mountain: `<svg viewBox="0 0 32 32"><path d="M2 28 L12 8 L17 16 L22 8 L30 28 Z" fill="none" stroke="#1a1a1a" stroke-width="1.5" stroke-linejoin="round"/></svg>`,
      wave: `<svg viewBox="0 0 32 32"><path d="M2 12 Q8 4 14 12 Q20 20 26 12 Q28 8 30 12" fill="none" stroke="#1a1a1a" stroke-width="1.5"/><path d="M2 22 Q8 14 14 22 Q20 30 26 22 Q28 18 30 22" fill="none" stroke="#1a1a1a" stroke-width="1.5"/></svg>`,
      leaf: `<svg viewBox="0 0 32 32"><path d="M16 28 Q4 16 16 2 Q28 16 16 28" fill="none" stroke="#1a1a1a" stroke-width="1.5"/><path d="M16 28 L16 12" fill="none" stroke="#1a1a1a" stroke-width="1"/></svg>`,
      sun: `<svg viewBox="0 0 32 32"><circle cx="16" cy="16" r="7" fill="none" stroke="#1a1a1a" stroke-width="1.5"/><g stroke="#1a1a1a" stroke-width="1.5"><line x1="16" y1="2" x2="16" y2="6"/><line x1="16" y1="26" x2="16" y2="30"/><line x1="2" y1="16" x2="6" y2="16"/><line x1="26" y1="16" x2="30" y2="16"/></g></svg>`,
      star: `<svg viewBox="0 0 32 32"><polygon points="16,2 19,12 28,12 21,18 24,28 16,22 8,28 11,18 4,12 13,12" fill="none" stroke="#1a1a1a" stroke-width="1.5"/></svg>`,
      globe: `<svg viewBox="0 0 32 32"><circle cx="16" cy="16" r="12" fill="none" stroke="#1a1a1a" stroke-width="1.5"/><ellipse cx="16" cy="16" rx="5" ry="12" fill="none" stroke="#1a1a1a" stroke-width="1"/><path d="M4 16 L28 16 M6 8 L26 8 M6 24 L26 24" fill="none" stroke="#1a1a1a" stroke-width="0.75"/></svg>`,
      envelope: `<svg viewBox="0 0 32 32"><rect x="4" y="8" width="24" height="16" fill="none" stroke="#1a1a1a" stroke-width="1.5" rx="1"/><path d="M4 8 L16 18 L28 8" fill="none" stroke="#1a1a1a" stroke-width="1.5"/></svg>`,
      bird: `<svg viewBox="0 0 32 32"><path d="M4 20 Q14 8 16 16 Q18 8 28 20" fill="none" stroke="#1a1a1a" stroke-width="1.5" stroke-linecap="round"/><path d="M10 24 Q16 16 22 24" fill="none" stroke="#1a1a1a" stroke-width="1.5" stroke-linecap="round"/></svg>`,
      heart: `<svg viewBox="0 0 32 32"><path d="M16 28 Q2 18 8 10 Q12 4 16 10 Q20 4 24 10 Q30 18 16 28" fill="none" stroke="#1a1a1a" stroke-width="1.5"/></svg>`,
      moon: `<svg viewBox="0 0 32 32"><path d="M22 4 A14 14 0 1 0 22 28 A10 10 0 1 1 22 4" fill="none" stroke="#1a1a1a" stroke-width="1.5"/></svg>`,
      camera: `<svg viewBox="0 0 32 32"><rect x="4" y="10" width="24" height="16" fill="none" stroke="#1a1a1a" stroke-width="1.5" rx="2"/><circle cx="16" cy="18" r="5" fill="none" stroke="#1a1a1a" stroke-width="1.5"/><rect x="11" y="6" width="6" height="4" fill="none" stroke="#1a1a1a" stroke-width="1"/></svg>`,
      coffee: `<svg viewBox="0 0 32 32"><path d="M6 8 L8 26 L22 26 L24 8 Z" fill="none" stroke="#1a1a1a" stroke-width="1.5"/><path d="M24 12 Q30 12 30 17 Q30 22 24 22" fill="none" stroke="#1a1a1a" stroke-width="1.5"/><path d="M11 4 Q11 8 14 8 Q17 8 17 4" fill="none" stroke="#1a1a1a" stroke-width="1" stroke-linecap="round"/></svg>`,
      none: `<svg viewBox="0 0 32 32"><line x1="8" y1="8" x2="24" y2="24" stroke="#ccc" stroke-width="1.5"/><line x1="24" y1="8" x2="8" y2="24" stroke="#ccc" stroke-width="1.5"/></svg>`
    };

    // Color palettes - generic vintage airmail styles
    const colorPalettes = [
      { name: 'Classic', colors: ['#C41E3A', '#1E3A5F'] },
      { name: 'Airmail', colors: ['#DC3545', '#0D47A1', '#FFFFFF'] },
      { name: 'Sepia', colors: ['#8B4513', '#D2691E'] },
      { name: 'Navy', colors: ['#1B3A57', '#C9A227'] },
      { name: 'Forest', colors: ['#2D5A3D', '#8B7355'] },
      { name: 'Burgundy', colors: ['#722F37', '#2C2C2C'] },
      { name: 'Slate', colors: ['#4A5568', '#1A202C'] },
      { name: 'Terracotta', colors: ['#C75B39', '#5D4E37'] },
      { name: 'Ocean', colors: ['#0077B6', '#023E8A'] },
      { name: 'Sunset', colors: ['#C44536', '#772E25'] },
      { name: 'Olive', colors: ['#606C38', '#283618'] },
      { name: 'Ink', colors: ['#1a1a1a', '#4a4a4a'] }
    ];

    // State
    let selectedSymbol = 'compass';
    let selectedPalette = colorPalettes[0];
    let wearLevel = 50;

    // Initialize symbol grid
    function initSymbolGrid() {
      const grid = document.getElementById('symbol-grid');
      Object.keys(icons).forEach(key => {
        const btn = document.createElement('button');
        btn.className = 'symbol-option' + (key === selectedSymbol ? ' selected' : '');
        btn.innerHTML = iconPreviews[key];
        btn.title = key;
        btn.onclick = () => {
          document.querySelectorAll('.symbol-option').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          selectedSymbol = key;
          updatePreview();
        };
        grid.appendChild(btn);
      });
    }

    // Initialize color grid
    function initColorGrid() {
      const grid = document.getElementById('color-grid');
      colorPalettes.forEach((palette, idx) => {
        const wrapper = document.createElement('div');

        const btn = document.createElement('button');
        btn.className = 'color-option' + (idx === 0 ? ' selected' : '');
        btn.title = palette.name;
        palette.colors.forEach(color => {
          const swatch = document.createElement('div');
          swatch.className = 'color-swatch';
          swatch.style.backgroundColor = color;
          if (color === '#FFFFFF') {
            swatch.style.borderRight = '1px solid #ddd';
          }
          btn.appendChild(swatch);
        });
        btn.onclick = () => {
          document.querySelectorAll('.color-option').forEach(b => b.classList.remove('selected'));
          btn.classList.add('selected');
          selectedPalette = palette;
          updatePreview();
        };

        const label = document.createElement('div');
        label.className = 'color-label';
        label.textContent = palette.name;

        wrapper.appendChild(btn);
        wrapper.appendChild(label);
        grid.appendChild(wrapper);
      });
    }

    // Generate stripes
    function generateStripes(colors, isTop) {
      const y = isTop ? 0 : 136;
      const stripePositions = [0, 44, 88, 132, 176, 220];

      return stripePositions.map((x, i) => {
        let colorIndex = isTop ? i % colors.length : (i + 1) % colors.length;
        let color = colors[colorIndex];
        const stroke = color === '#FFFFFF' ? ' stroke="#ddd" stroke-width="0.5"' : '';
        return `<rect x="${x}" y="${y}" width="22" height="14" fill="${color}"${stroke}/>`;
      }).join('\n    ');
    }

    // Generate postmark SVG
    function generatePostmark() {
      const city = document.getElementById('city-input').value || 'Your City';
      const country = document.getElementById('country-input').value || 'Country';
      const native = document.getElementById('native-input').value;

      const colors = selectedPalette.colors;
      const iconFn = icons[selectedSymbol] || icons.none;
      const iconSvg = iconFn(colors[0]);

      const cityFontSize = city.length > 10 ? 26 : 32;
      const cityY = city.length > 10 ? 72 : 75;
      const subtitleFontSize = country.length > 15 ? 14 : 16;
      const subtitleY = city.length > 10 ? 98 : 100;

      const subtitle = native ? `${country} · ${native}` : country;

      // Wear intensity (0-100 scaled to usable values)
      const wear = wearLevel / 100;

      // Deterministic random based on city name
      const seed = city.split('').reduce((acc, c) => acc + c.charCodeAt(0), 0);
      const rand = (n) => ((seed * (n + 1) * 9301 + 49297) % 233280) / 233280;
      const rotation = wear > 0 ? (rand(0) - 0.5) * 5 * wear : 0;

      // Generate large fade patches
      const fadePatches = [];
      const numPatches = Math.floor(wear * 8) + (wear > 0.3 ? 2 : 0);
      for (let i = 0; i < numPatches; i++) {
        const x = rand(i * 3) * 220 + 20;
        const y = rand(i * 3 + 1) * 110 + 20;
        const rx = rand(i * 3 + 2) * 25 * wear + 15;
        const ry = rx * (rand(i * 8) * 0.5 + 0.4);
        const opacity = (rand(i * 7) * 0.25 + 0.1) * wear;
        fadePatches.push(`<ellipse cx="${x.toFixed(1)}" cy="${y.toFixed(1)}" rx="${rx.toFixed(1)}" ry="${ry.toFixed(1)}" fill="rgba(255,255,255,${opacity.toFixed(2)})" transform="rotate(${rand(i*5) * 360} ${x.toFixed(1)} ${y.toFixed(1)})"/>`);
      }

      // Generate ink chips on stripes
      const inkChips = [];
      const numChips = Math.floor(wear * 20) + (wear > 0.5 ? 8 : 0);
      for (let i = 0; i < numChips; i++) {
        const x = rand(i * 4 + 20) * 250 + 5;
        const onTop = rand(i * 4 + 21) < 0.5;
        const y = onTop ? rand(i * 4 + 22) * 12 + 1 : 137 + rand(i * 4 + 22) * 11;
        const w = rand(i * 4 + 23) * 8 * wear + 2;
        const h = rand(i * 4 + 24) * 6 * wear + 2;
        const opacity = rand(i*6) * 0.6 * wear + 0.3;
        inkChips.push(`<rect x="${x.toFixed(1)}" y="${y.toFixed(1)}" width="${w.toFixed(1)}" height="${h.toFixed(1)}" fill="rgba(255,255,255,${opacity.toFixed(2)})"/>`);
      }

      // Generate scratches/scuff lines
      const scratches = [];
      const numScratches = Math.floor(wear * 6);
      for (let i = 0; i < numScratches; i++) {
        const x1 = rand(i * 5 + 50) * 200 + 30;
        const y1 = rand(i * 5 + 51) * 120 + 15;
        const length = rand(i * 5 + 52) * 40 * wear + 15;
        const angle = rand(i * 5 + 53) * 40 - 20;
        const x2 = x1 + length * Math.cos(angle * Math.PI / 180);
        const y2 = y1 + length * Math.sin(angle * Math.PI / 180);
        const opacity = rand(i * 5 + 54) * 0.15 * wear + 0.05;
        scratches.push(`<line x1="${x1.toFixed(1)}" y1="${y1.toFixed(1)}" x2="${x2.toFixed(1)}" y2="${y2.toFixed(1)}" stroke="rgba(255,255,255,${opacity.toFixed(2)})" stroke-width="${(rand(i*9) * 3 * wear + 1).toFixed(1)}"/>`);
      }

      // Edge wear - rough edges on stripes
      const edgeWear = [];
      if (wear > 0.2) {
        const numEdgeMarks = Math.floor(wear * 15);
        for (let i = 0; i < numEdgeMarks; i++) {
          const x = rand(i * 6 + 100) * 260;
          const onTop = rand(i * 6 + 101) < 0.5;
          const y = onTop ? rand(i * 6 + 102) * 4 : 146 + rand(i * 6 + 102) * 4;
          const w = rand(i * 6 + 103) * 6 * wear + 2;
          const h = rand(i * 6 + 104) * 5 * wear + 2;
          edgeWear.push(`<rect x="${x.toFixed(1)}" y="${y.toFixed(1)}" width="${w.toFixed(1)}" height="${h.toFixed(1)}" fill="rgba(255,255,255,${(rand(i*6+105) * 0.7 + 0.3).toFixed(2)})"/>`);
        }
      }

      // Dust specks
      const dustSpecks = [];
      if (wear > 0.4) {
        const numSpecks = Math.floor(wear * 25);
        for (let i = 0; i < numSpecks; i++) {
          const x = rand(i * 2 + 200) * 260;
          const y = rand(i * 2 + 201) * 150;
          const r = rand(i * 2 + 202) * 2 * wear + 0.5;
          const opacity = rand(i * 2 + 203) * 0.3 * wear;
          dustSpecks.push(`<circle cx="${x.toFixed(1)}" cy="${y.toFixed(1)}" r="${r.toFixed(1)}" fill="rgba(100,80,60,${opacity.toFixed(2)})"/>`);
        }
      }

      // Wear marks only if wear > 0
      const wearMarkup = wear > 0 ? `
      <!-- Large fade patches -->
      ${fadePatches.join('\n      ')}
      <!-- Ink chips on stripes -->
      ${inkChips.join('\n      ')}
      <!-- Scratches -->
      ${scratches.join('\n      ')}
      <!-- Edge wear -->
      ${edgeWear.join('\n      ')}
      <!-- Dust specks -->
      ${dustSpecks.join('\n      ')}` : '';

      return `<svg width="280" height="170" viewBox="-10 -10 280 170" fill="none" xmlns="http://www.w3.org/2000/svg">
    <g transform="rotate(${rotation.toFixed(2)} 130 75)">
      <!-- Top stripes -->
      ${generateStripes(colors, true)}
      <!-- Bottom stripes -->
      ${generateStripes(colors, false)}

      <!-- Content -->
      <text x="130" y="42" text-anchor="middle" font-family="Georgia, serif" font-size="10" letter-spacing="3" fill="#888">A DISPATCH FROM</text>
      <text x="130" y="${cityY}" text-anchor="middle" font-family="Georgia, serif" font-size="${cityFontSize}" font-weight="bold" fill="#1a1a1a">${escapeHtml(city)}</text>
      <text x="130" y="${subtitleY}" text-anchor="middle" font-family="Georgia, serif" font-size="${subtitleFontSize}" fill="#666">${escapeHtml(subtitle)}</text>
      <!-- Icon -->
      ${iconSvg}
      ${wearMarkup}
    </g>
  </svg>`;
    }

    // Escape HTML entities
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Update preview
    function updatePreview() {
      const svg = generatePostmark();
      document.getElementById('preview-svg').innerHTML = svg;
    }

    // Download SVG
    function downloadSvg() {
      const svg = generatePostmark();
      const city = document.getElementById('city-input').value || 'postmark';
      const filename = city.toLowerCase().replace(/\s+/g, '-') + '.svg';

      const blob = new Blob([svg], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initSymbolGrid();
      initColorGrid();
      updatePreview();

      // Input listeners
      document.getElementById('city-input').addEventListener('input', updatePreview);
      document.getElementById('country-input').addEventListener('input', updatePreview);
      document.getElementById('native-input').addEventListener('input', updatePreview);

      // Download button
      document.getElementById('download-btn').addEventListener('click', downloadSvg);

      // Wear slider
      const wearSlider = document.getElementById('wear-slider');
      const wearValue = document.getElementById('wear-value');
      const wearLabels = ['Pristine', 'Light', 'Medium', 'Heavy', 'Weathered'];

      function updateWearLabel() {
        const idx = Math.min(Math.floor(wearLevel / 25), 4);
        wearValue.textContent = wearLabels[idx];
      }

      wearSlider.addEventListener('input', (e) => {
        wearLevel = parseInt(e.target.value);
        updateWearLabel();
        updatePreview();
      });

      // Example buttons
      document.querySelectorAll('.example-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          // Fill in text fields
          document.getElementById('city-input').value = btn.dataset.city;
          document.getElementById('country-input').value = btn.dataset.country;
          document.getElementById('native-input').value = btn.dataset.native;

          // Select symbol
          const symbolKey = btn.dataset.symbol;
          document.querySelectorAll('.symbol-option').forEach(opt => opt.classList.remove('selected'));
          const symbolBtns = document.querySelectorAll('.symbol-option');
          const symbolKeys = Object.keys(icons);
          const symbolIdx = symbolKeys.indexOf(symbolKey);
          if (symbolIdx >= 0 && symbolBtns[symbolIdx]) {
            symbolBtns[symbolIdx].classList.add('selected');
            selectedSymbol = symbolKey;
          }

          // Select palette
          const paletteIdx = parseInt(btn.dataset.palette);
          document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
          const paletteBtns = document.querySelectorAll('.color-option');
          if (paletteBtns[paletteIdx]) {
            paletteBtns[paletteIdx].classList.add('selected');
            selectedPalette = colorPalettes[paletteIdx];
          }

          updatePreview();
        });
      });
    });
  </script>
</body>
</html>
